<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-06-30 Wed 19:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My development environment image</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jakub Šťastný" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/dev/styles.css"/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">My development environment image</h1>

<div id="outline-container-org259f89d" class="outline-2">
<h2 id="org259f89d"><span class="section-number-2">1</span> About</h2>
<div class="outline-text-2" id="text-1">

<div id="org9db8f3d" class="figure">
<p><a href="https://github.com/jakub-stastny/dev/actions/workflows/test.yml" fallback="https://github.com/jakub-stastny/dev/actions/workflows/test.yml/badge.svg"><object type="image/svg+xml" data="https://github.com/jakub-stastny/dev/actions/workflows/test.yml/badge.svg" class="org-svg">
<img src="https://github.com/jakub-stastny/dev/actions/workflows/test.yml/badge.svg" class="org-svg" /></object></a>
</p>
</div>

<p>
My development environment with my favourite tools and dotfiles.
</p>

<p>
I use it with <a href="https://github.com/jakub-stastny/docker-project-manager">docker-project-manager</a>, which automates the usual project workflow: creating a project, spinning off a Docker image with that environment, creating a new pair of SSH keys and setting up port sharing. The resulting container runs OpenSSH server and can be SSH'd into directly, without the need to connect to the host machine first.
</p>
</div>
</div>

<div id="outline-container-orgde88216" class="outline-2">
<h2 id="orgde88216"><span class="section-number-2">2</span> Dockerfile</h2>
<div class="outline-text-2" id="text-2">
</div>

<div id="outline-container-org11d0f27" class="outline-3">
<h3 id="org11d0f27"><span class="section-number-3">2.1</span> Use the latest Ubuntu</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">FROM</span> <span style="color: #0072b2; font-weight: bold;">ubuntu:latest</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9323227" class="outline-3">
<h3 id="org9323227"><span class="section-number-3">2.2</span> Set <code>WORKDIR</code> to <code>/root</code></h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">WORKDIR</span> /root
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb6f455" class="outline-3">
<h3 id="orgbb6f455"><span class="section-number-3">2.3</span> Set <code>TERM</code> to <code>xterm-256color</code></h3>
<div class="outline-text-3" id="text-2-3">
<p>
Silence <code>tput</code> warnings and show colours instead.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">TERM</span>=xterm-256color
</pre>
</div>
</div>
</div>

<div id="outline-container-org4678859" class="outline-3">
<h3 id="org4678859"><span class="section-number-3">2.4</span> Set up <code>$PATH</code></h3>
<div class="outline-text-3" id="text-2-4">
<p>
Even though we do this in dotfiles, having it exported means we can use these custom scripts when building a DPM image. For instance in the home image we use dotfiles from <code>~/.script/dotfiles</code>.
</p>

<p>
This has less importance now, since we switched to connecting to the image directly over SSH, which doesn't respect ENV variables, but it's still useful, for instance so we can do <code>dotfiles pull -r</code> in our project <code>Dockerfile</code>.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">PATH</span>=<span style="color: #848ea9;">"/root/.scripts:${PATH}"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e1491d" class="outline-3">
<h3 id="org5e1491d"><span class="section-number-3">2.5</span> Update APT cache and upgrade packages</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">RUN</span> apt-get update &gt; /dev/null &amp;&amp; <span style="color: #e69f00; font-weight: bold;">DEBIAN_FRONTEND</span>=noninteractive apt-get upgrade -y &gt; /dev/null
</pre>
</div>
</div>
</div>

<div id="outline-container-orge212c44" class="outline-3">
<h3 id="orge212c44"><span class="section-number-3">2.6</span> Fix locale</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Ubuntu has broken locale. We need to set the variables here, in order for them to be available both to the install script and to the final environment. Locale is generated in the install script.
</p>

<p>
There's a Perl locale error when setting up locales. Ignore.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">LC_ALL</span>=en_US.UTF-8 <span style="color: #e69f00; font-weight: bold;">LANG</span>=en_US.UTF-8 <span style="color: #e69f00; font-weight: bold;">LANGUAGE</span>=en_US.UTF-8
<span style="color: #56b4e9; font-weight: bold;">RUN</span> apt-get install -y locales &gt; /dev/null &amp;&amp; locale-gen $<span style="color: #e69f00; font-weight: bold;">LC_ALL</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbcffe09" class="outline-3">
<h3 id="orgbcffe09"><span class="section-number-3">2.7</span> Install apt-utils</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Installing <code>apt-utils</code> will stop annoying warning every time I try to install something.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">RUN</span> <span style="color: #e69f00; font-weight: bold;">DEBIAN_FRONTEND</span>=noninteractive apt-get install -y apt-utils &gt; /dev/null
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdfbea35" class="outline-3">
<h3 id="orgdfbea35"><span class="section-number-3">2.8</span> Install ZSH and babashka as a prerequisite for the build scripts</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">RUN</span> <span style="color: #e69f00; font-weight: bold;">DEBIAN_FRONTEND</span>=noninteractive apt-get install -y zsh curl &gt; /dev/null
<span style="color: #56b4e9; font-weight: bold;">RUN</span> curl https://raw.githubusercontent.com/babashka/babashka/master/install | bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org56ebf07" class="outline-3">
<h3 id="org56ebf07"><span class="section-number-3">2.9</span> Add the build scripts</h3>
<div class="outline-text-3" id="text-2-9">
<p>
I purposedly want to leave the scripts in the build, as they might come in handy for future inspection.
</p>

<p>
I don't do <code>ADD /build</code>, since any change in any of the files invalidates Docker cache.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/unminimise-system /build/unminimise-system
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/unminimise-system

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/install-emacs-dependencies /build/install-emacs-dependencies
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/install-emacs-dependencies

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/build-emacs /build/build-emacs
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/build-emacs

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/install-basic-tools /build/install-basic-tools
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/install-basic-tools

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/add-node-sources /build/add-node-sources
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/add-node-sources

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/set-up-time-zone /build/set-up-time-zone
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/set-up-time-zone

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/install-dotfiles /build/install-dotfiles
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/install-dotfiles

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/install-clojure-cli /build/install-clojure-cli
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/install-clojure-cli

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/install-gh-cli /build/install-gh-cli
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/install-gh-cli

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/make-zsh-the-default-shell /build/make-zsh-the-default-shell
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/make-zsh-the-default-shell

<span style="color: #56b4e9; font-weight: bold;">ADD</span> scripts/secure-installation /build/secure-installation
<span style="color: #56b4e9; font-weight: bold;">RUN</span> /build/secure-installation
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b0616d" class="outline-3">
<h3 id="org6b0616d"><span class="section-number-3">2.10</span> Save build metadata</h3>
<div class="outline-text-3" id="text-2-10">
<p>
We are passing these build args to <code>docker build</code> in <a href="./bin/build">./bin/build</a>.
</p>

<p>
Previously we have been saving these into a file, but really, an ENV variable is better suited for this.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ARG</span> DOCKER_IMAGE_GIT_SHA
<span style="color: #56b4e9; font-weight: bold;">ARG</span> DOCKER_IMAGE_BUILD_DATE

<span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">DOCKER_IMAGE_GIT_SHA</span>=$<span style="color: #e69f00; font-weight: bold;">DOCKER_IMAGE_GIT_SHA</span>
<span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">DOCKER_IMAGE_BUILD_DATE</span>=$<span style="color: #e69f00; font-weight: bold;">DOCKER_IMAGE_BUILD_DATE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org58c69c0" class="outline-3">
<h3 id="org58c69c0"><span class="section-number-3">2.11</span> Run OpenSSH server</h3>
<div class="outline-text-3" id="text-2-11">
<p>
This allows us to connect directly, rather than having to go through the host machine.
</p>

<p>
On the flip side, it render many declarations made in the project <code>Dockerfile</code> useless: namely <code>ENV</code> and <code>WORKDIR</code> declarations.
</p>

<p>
Just redefine <code>SSHD_PORT</code> for each of the project images, so that they don't clash and you'll be able to connect straight to the running image from your SSH terminal.
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #56b4e9; font-weight: bold;">ENV</span> <span style="color: #e69f00; font-weight: bold;">SSHD_PORT</span>=2222
<span style="color: #56b4e9; font-weight: bold;">CMD</span> /usr/sbin/sshd -p $<span style="color: #e69f00; font-weight: bold;">SSHD_PORT</span> -D -e
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org05913fd" class="outline-2">
<h2 id="org05913fd"><span class="section-number-2">3</span> The build scripts</h2>
<div class="outline-text-2" id="text-3">
</div>

<div id="outline-container-org2b8bd2f" class="outline-3">
<h3 id="org2b8bd2f"><span class="section-number-3">3.1</span> Helpers</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Keep in mind that changing the helpers will invalidate Docker cache for all the build scripts.
</p>
</div>

<div id="outline-container-orgecb861b" class="outline-4">
<h4 id="orgecb861b"><span class="section-number-4">3.1.1</span> <span class="todo TODO">TODO</span> Refactor to group side-effects in one place</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Since this is just the first working version, I didn't bother with the design, but now it should be refactored to behave more declaratively: to generate a representation of the commands, rather than executing them directly.
</p>

<p>
Only after we get to the end of the <code>block</code>, the commands in it should execute and that's when all the side-effects should happen.
</p>
</div>
</div>

<div id="outline-container-orgb9a70c7" class="outline-4">
<h4 id="orgb9a70c7"><span class="section-number-4">3.1.2</span> <span class="todo TODO">TODO</span> Show current duration of execution</h4>
<div class="outline-text-4" id="text-3-1-2">
<ul class="org-ul">
<li><a href="https://book.babashka.org/#core_async">Babashka async</a></li>
<li><a href="https://stackoverflow.com/questions/5290994/remove-and-replace-printed-items#5291396">ASCII escape sequence </a></li>
</ul>

<div class="org-src-container">
<pre class="src src-clojure" id="org6015a06">(require '[clojure.java.shell <span style="color: #d55e00; font-weight: bold;">:refer</span> [sh with-sh-dir]])

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">zsh</span>
  ([command] (sh <span style="color: #848ea9;">"zsh"</span> <span style="color: #848ea9;">"-c"</span> command))
  ([command env] (apply sh <span style="color: #848ea9;">"zsh"</span> <span style="color: #848ea9;">"-c"</span> command env)))

(<span style="color: #56b4e9; font-weight: bold;">def</span> <span style="color: #e69f00; font-weight: bold;">colours</span> {
  <span style="color: #d55e00; font-weight: bold;">:red</span> 31 <span style="color: #d55e00; font-weight: bold;">:green</span> 32 <span style="color: #d55e00; font-weight: bold;">:yellow</span> 33
  <span style="color: #d55e00; font-weight: bold;">:blue</span> 34 <span style="color: #d55e00; font-weight: bold;">:purple</span> 35 <span style="color: #d55e00; font-weight: bold;">:cyan</span> 36
  <span style="color: #d55e00; font-weight: bold;">:grey</span> 37})

<span style="color: #7f7f7f;">; </span><span style="color: #009e73; font-style: italic;">\033[fg;bgm</span>
(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">colour</span> [colour text]
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [colour-code (colour colours)]
    (str <span style="color: #848ea9;">"</span><span style="color: #848ea9; font-weight: bold;">\0</span><span style="color: #848ea9;">33["</span> colour-code <span style="color: #848ea9;">"m"</span> text <span style="color: #848ea9;">"</span><span style="color: #848ea9; font-weight: bold;">\0</span><span style="color: #848ea9;">33[0m"</span>)))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">current-unix-time</span> [] (quot (<span style="color: #0072b2; font-weight: bold;">System</span>/currentTimeMillis) 1000))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">format-duration</span> [duration]
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [colour-name (<span style="color: #56b4e9; font-weight: bold;">cond</span> (&lt; duration 35) <span style="color: #d55e00; font-weight: bold;">:green</span> (&lt; duration 90) <span style="color: #d55e00; font-weight: bold;">:yellow</span> <span style="color: #d55e00; font-weight: bold;">:else</span> <span style="color: #d55e00; font-weight: bold;">:red</span>)]
   (<span style="color: #56b4e9; font-weight: bold;">cond</span>
     (&lt; duration 60) (colour colour-name (str duration <span style="color: #848ea9;">"s"</span>))
     (&gt; duration 60) (colour colour-name (str (int (/ duration 60.0)) <span style="color: #848ea9;">":"</span> (format <span style="color: #848ea9;">"%02d"</span> (mod duration 60)) <span style="color: #848ea9;">"m"</span>)))))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">format-duration-wrapper</span>
  ([duration] (<span style="color: #56b4e9; font-weight: bold;">if</span> (&lt;= duration 3) <span style="color: #848ea9;">""</span> (str <span style="color: #848ea9;">"took "</span> (format-duration duration) <span style="color: #848ea9;">"."</span>)))
  ([duration lambda] (<span style="color: #56b4e9; font-weight: bold;">if</span> (&lt;= duration 3) <span style="color: #848ea9;">""</span> (lambda (format-duration-wrapper duration)))))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">run</span> [command &amp; rest]
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [start-time (current-unix-time)]
    (print (str <span style="color: #848ea9;">"  "</span> (colour <span style="color: #d55e00; font-weight: bold;">:green</span> <span style="color: #848ea9;">"&#955; "</span>) (colour <span style="color: #d55e00; font-weight: bold;">:grey</span> command)) <span style="color: #848ea9;">""</span>)
    (flush)
    (<span style="color: #56b4e9; font-weight: bold;">let</span> [result (zsh command rest)]
      (<span style="color: #56b4e9; font-weight: bold;">let</span> [duration (- (current-unix-time) start-time)]
        (<span style="color: #56b4e9; font-weight: bold;">let</span> [format-fn (<span style="color: #56b4e9; font-weight: bold;">fn</span> [formatted-duration-string] (str <span style="color: #848ea9;">"... "</span> formatted-duration-string))]
          (println (format-duration-wrapper duration format-fn)))
        result))))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">fail</span> [result]
  (println (str (colour <span style="color: #d55e00; font-weight: bold;">:red</span> <span style="color: #848ea9;">"    Error "</span>) (<span style="color: #d55e00; font-weight: bold;">:exit</span> result)))
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [out (<span style="color: #d55e00; font-weight: bold;">:out</span> result) err (<span style="color: #d55e00; font-weight: bold;">:err</span> result)]
    (<span style="color: #56b4e9; font-weight: bold;">when-not</span> (empty? out) (println out))
    (<span style="color: #56b4e9; font-weight: bold;">when-not</span> (empty? err) (println err)))
  (<span style="color: #0072b2; font-weight: bold;">System</span>/exit 1))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">ensure-success</span> [result]
  (<span style="color: #56b4e9; font-weight: bold;">if</span> (= (<span style="color: #d55e00; font-weight: bold;">:exit</span> result) 0) result (fail result)))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">label</span> [text]
  (println (colour <span style="color: #d55e00; font-weight: bold;">:purple</span> text)))

(<span style="color: #56b4e9; font-weight: bold;">defmacro</span> <span style="color: #d55e00; font-weight: bold;">block</span> [name &amp; sexps]
  `(<span style="color: #56b4e9; font-weight: bold;">do</span>
    (println <span style="color: #848ea9;">"</span><span style="color: #848ea9; font-weight: bold;">\n</span><span style="color: #848ea9;">Running block"</span> (str (colour <span style="color: #d55e00; font-weight: bold;">:purple</span> ~name) <span style="color: #848ea9;">".</span><span style="color: #848ea9; font-weight: bold;">\n</span><span style="color: #848ea9;">"</span>))
    (<span style="color: #56b4e9; font-weight: bold;">let</span> [start-time (current-unix-time)]
      (<span style="color: #56b4e9; font-weight: bold;">do</span> ~@sexps)
      (<span style="color: #56b4e9; font-weight: bold;">let</span> [duration (- (current-unix-time) start-time)]
        (println (colour <span style="color: #d55e00; font-weight: bold;">:cyan</span> <span style="color: #848ea9;">"</span><span style="color: #848ea9; font-weight: bold;">\n</span><span style="color: #848ea9;">  ~"</span>) <span style="color: #848ea9;">"Block"</span> (colour <span style="color: #d55e00; font-weight: bold;">:grey</span> ~name) (format-duration-wrapper duration) <span style="color: #848ea9;">"</span><span style="color: #848ea9; font-weight: bold;">\n</span><span style="color: #848ea9;">"</span>)))))

(<span style="color: #56b4e9; font-weight: bold;">defn</span> <span style="color: #d55e00; font-weight: bold;">package</span> [&amp; names]
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [command (str <span style="color: #848ea9;">"apt-get install -y "</span> (<span style="color: #0072b2; font-weight: bold;">clojure.string</span>/join <span style="color: #848ea9;">" "</span> names))]
    (ensure-success (run command <span style="color: #d55e00; font-weight: bold;">:env</span> {<span style="color: #848ea9;">"DEBIAN_FRONTEND"</span> <span style="color: #848ea9;">"noninteractive"</span>}))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf1d9b21" class="outline-3">
<h3 id="orgf1d9b21"><span class="section-number-3">3.2</span> Unminimise the system</h3>
<div class="outline-text-3" id="text-3-2">
<p>
This makes man pages available.
</p>

<p>
Gives <code>Reinstallation of gh is not possible, it cannot be downloaded.</code>, so GH CLI has to be installed after.
</p>

<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"unminimising the system"</span>
  (package <span style="color: #848ea9;">"man"</span>)
  (ensure-success (run <span style="color: #848ea9;">"yes | unminimize"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org825668d" class="outline-3">
<h3 id="org825668d"><span class="section-number-3">3.3</span> Install Emacs 28 with native compilation, fast JSON parser and better redo</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"installing Emacs dependencies"</span>
  (package <span style="color: #848ea9;">"git"</span>)
  (ensure-success (run <span style="color: #848ea9;">"git clone --depth 1 https://git.savannah.gnu.org/git/emacs.git"</span>))

  <span style="color: #009e73; font-style: italic;">; Dependencies from https://packages.ubuntu.com/impish/emacs-nox (libncurses-dev isn't listed, but is required)</span>
  (package <span style="color: #848ea9;">"libacl1"</span> <span style="color: #848ea9;">"libasound2"</span> <span style="color: #848ea9;">"libc6"</span> <span style="color: #848ea9;">"libdbus-1-3"</span> <span style="color: #848ea9;">"libgmp10"</span> <span style="color: #848ea9;">"libgnutls28-dev"</span> <span style="color: #848ea9;">"libgpm2"</span> <span style="color: #848ea9;">"libjansson4"</span> <span style="color: #848ea9;">"liblcms2-2"</span> <span style="color: #848ea9;">"libselinux1"</span> <span style="color: #848ea9;">"libsystemd0"</span> <span style="color: #848ea9;">"libtinfo6"</span> <span style="color: #848ea9;">"libxml2"</span> <span style="color: #848ea9;">"zlib1g"</span> <span style="color: #848ea9;">"libncurses-dev"</span>)

  <span style="color: #009e73; font-style: italic;">; Dependencies for building Emacs.</span>
  (package <span style="color: #848ea9;">"build-essential"</span> <span style="color: #848ea9;">"texinfo"</span> <span style="color: #848ea9;">"autoconf"</span> <span style="color: #848ea9;">"pkg-config"</span>)

  <span style="color: #009e73; font-style: italic;">; Needed for fast JSON</span>
  (package <span style="color: #848ea9;">"libjansson4"</span> <span style="color: #848ea9;">"libjansson-dev"</span>)

  <span style="color: #009e73; font-style: italic;">; Dependencies for native compilation</span>
  (package <span style="color: #848ea9;">"zlib1g-dev"</span> <span style="color: #848ea9;">"libgccjit0"</span> <span style="color: #848ea9;">"libgccjit-10-dev"</span> <span style="color: #848ea9;">"gcc-10"</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"building Emacs 28 with native compilation and fast JSON"</span>
  (with-sh-dir <span style="color: #848ea9;">"emacs"</span>
    (<span style="color: #56b4e9; font-weight: bold;">let</span> [path (<span style="color: #0072b2; font-weight: bold;">System</span>/getenv <span style="color: #848ea9;">"PATH"</span>) cc <span style="color: #848ea9;">"gcc-10"</span>]
      (ensure-success (run <span style="color: #848ea9;">"./autogen.sh"</span>))
      (ensure-success (run <span style="color: #848ea9;">"./configure --with-native-compilation"</span> <span style="color: #d55e00; font-weight: bold;">:env</span> {<span style="color: #848ea9;">"PATH"</span> path <span style="color: #848ea9;">"CC"</span> cc}))
      (ensure-success (run <span style="color: #848ea9;">"make -j$(nproc)"</span>))
      (ensure-success (run <span style="color: #848ea9;">"make install"</span> ))))
  (ensure-success (run <span style="color: #848ea9;">"rm -rf emacs"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb68007d" class="outline-3">
<h3 id="orgb68007d"><span class="section-number-3">3.4</span> Install basic tools</h3>
<div class="outline-text-3" id="text-3-4">
<p>
<code>expect-dev</code> is for autologin scripts.
</p>

<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"installing basic tools"</span>
  (package <span style="color: #848ea9;">"locales"</span> <span style="color: #848ea9;">"automake"</span> <span style="color: #848ea9;">"htop"</span> <span style="color: #848ea9;">"curl"</span> <span style="color: #848ea9;">"wget"</span> <span style="color: #848ea9;">"git"</span> <span style="color: #848ea9;">"silversearcher-ag"</span> <span style="color: #848ea9;">"neovim"</span> <span style="color: #848ea9;">"docker.io"</span> <span style="color: #848ea9;">"tmux"</span> <span style="color: #848ea9;">"tree"</span> <span style="color: #848ea9;">"expect-dev"</span> <span style="color: #848ea9;">"rlwrap"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d0a4c2" class="outline-3">
<h3 id="org5d0a4c2"><span class="section-number-3">3.5</span> Node.js &amp; Yarn sources</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Add Yarn sources (without installing it).
<a href="https://yarnpkg.com/lang/en/docs/install/#debian-stable">https://yarnpkg.com/lang/en/docs/install/#debian-stable</a>
<a href="https://github.com/nodesource/distributions">https://github.com/nodesource/distributions</a>
</p>

<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"adding apt sources for Node.js"</span>
  (package <span style="color: #848ea9;">"gnupg"</span>)
  (ensure-success (run <span style="color: #848ea9;">"curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - &amp;&amp; echo deb https://dl.yarnpkg.com/debian/ stable main | tee /etc/apt/sources.list.d/yarn.list"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8da61e7" class="outline-3">
<h3 id="org8da61e7"><span class="section-number-3">3.6</span> Time zone</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"setting up time zone"</span>
  (package <span style="color: #848ea9;">"tzdata"</span>)
  (ensure-success (run <span style="color: #848ea9;">"echo America/New_York &gt; /etc/timezone"</span>))
  (ensure-success (run <span style="color: #848ea9;">"dpkg-reconfigure -f noninteractive tzdata"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5505d3" class="outline-3">
<h3 id="orge5505d3"><span class="section-number-3">3.7</span> Dotfiles</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Our <code>WORKDIR</code> is <code>/root</code>, so we don't have to <code>cd</code> anywhere.
</p>
</div>

<div id="outline-container-orge100a3a" class="outline-4">
<h4 id="orge100a3a"><span class="section-number-4">3.7.1</span> Install traditional dotfiles</h4>
<div class="outline-text-4" id="text-3-7-1">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"installing dotfiles"</span>
  (ensure-success (run <span style="color: #848ea9;">"mkdir .ssh &amp;&amp; chmod 700 .ssh &amp;&amp; git clone https://github.com/jakub-stastny/dotfiles.git .dotfiles.git --bare &amp;&amp; git --git-dir=/root/.dotfiles.git config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*' &amp;&amp; git --git-dir=/root/.dotfiles.git fetch &amp;&amp; git --git-dir=/root/.dotfiles.git branch --set-upstream-to=origin/master master &amp;&amp; git --git-dir=/root/.dotfiles.git --work-tree=/root checkout &amp;&amp; ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts &amp;&amp; zsh ~/.scripts/hooks/dotfiles.install &amp;&amp; git --git-dir=/root/.dotfiles.git remote set-url origin git@github.com:jakub-stastny/dotfiles.git &amp;&amp; rm -rf ~/.ssh"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5e3678" class="outline-4">
<h4 id="orgc5e3678"><span class="section-number-4">3.7.2</span> Install literate dotfiles</h4>
<div class="outline-text-4" id="text-3-7-2">
<div class="org-src-container">
<pre class="src src-elisp" id="orgfa4186f">(<span style="color: #56b4e9; font-weight: bold;">progn</span> (<span style="color: #56b4e9; font-weight: bold;">dolist</span> (file command-line-args-left) (<span style="color: #56b4e9; font-weight: bold;">with-current-buffer</span> (find-file-noselect file) (org-babel-tangle))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-clojure">(block <span style="color: #848ea9;">"tangling literate dotfiles"</span>
  (with-sh-dir <span style="color: #848ea9;">"/root/org"</span>
    (ensure-success (run <span style="color: #848ea9;">"emacs -Q --batch --eval '&lt;&lt;tangle&gt;&gt;' **/*.org"</span>))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9051f87" class="outline-3">
<h3 id="org9051f87"><span class="section-number-3">3.8</span> Clojure CLI</h3>
<div class="outline-text-3" id="text-3-8">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"installing Clojure CLI"</span>
  (<span style="color: #56b4e9; font-weight: bold;">let</span> [script-name <span style="color: #848ea9;">"linux-install.sh"</span>]
    (ensure-success (run (str <span style="color: #848ea9;">"curl https://download.clojure.org/install/linux-install-1.10.3.855.sh -o "</span> script-name)))
    (ensure-success (run (str <span style="color: #848ea9;">"chmod +x "</span> script-name)))
    (ensure-success (run (str <span style="color: #848ea9;">"./"</span> script-name)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga9a997d" class="outline-3">
<h3 id="orga9a997d"><span class="section-number-3">3.9</span> GH CLI</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"installing GitHub CLI"</span>
  (ensure-success (run <span style="color: #848ea9;">"curl curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg"</span>))
  (ensure-success (run <span style="color: #848ea9;">"echo </span><span style="color: #848ea9; font-weight: bold;">\"</span><span style="color: #848ea9;">deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main</span><span style="color: #848ea9; font-weight: bold;">\"</span><span style="color: #848ea9;"> | tee /etc/apt/sources.list.d/github-cli.list"</span>))
  (ensure-success (run <span style="color: #848ea9;">"apt-get update"</span>))
  (package <span style="color: #848ea9;">"gh"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba4564d" class="outline-3">
<h3 id="orgba4564d"><span class="section-number-3">3.10</span> Make ZSH the default shell</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"making ZSH the default shell"</span>
  (ensure-success (run <span style="color: #848ea9;">"chsh -s $(which zsh)"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org59ad313" class="outline-3">
<h3 id="org59ad313"><span class="section-number-3">3.11</span> Set up SSH and change root password</h3>
<div class="outline-text-3" id="text-3-11">
<div class="org-src-container">
<pre class="src src-clojure">&lt;&lt;bb-helpers&gt;&gt;

(block <span style="color: #848ea9;">"setting up OpenSSH server and securing the installation"</span>
  (package <span style="color: #848ea9;">"openssh-server"</span> <span style="color: #848ea9;">"mosh"</span>)
  (ensure-success (run <span style="color: #848ea9;">"mkdir /run/sshd"</span>))
  (ensure-success (run <span style="color: #848ea9;">"echo 'PasswordAuthentication no' &gt;&gt; /etc/ssh/sshd_config"</span>))
  (ensure-success (run <span style="color: #848ea9;">"echo </span><span style="color: #848ea9; font-weight: bold;">\"</span><span style="color: #848ea9;">root:$(tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 32)</span><span style="color: #848ea9; font-weight: bold;">\"</span><span style="color: #848ea9;"> | chpasswd"</span>)))
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
